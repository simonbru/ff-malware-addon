#!/usr/bin/env python2

from __future__ import (unicode_literals, print_function, with_statement,
                        generators)

import os
import sys
from ConfigParser import ConfigParser

from pathlib import Path


def local_profiles():
    ini_path = Path(os.environ['appdata']) / 'Mozilla/Firefox/profiles.ini'
    parser = ConfigParser()
    parser.read([ini_path.as_posix()])
    for section in parser.sections():
        if section.lower() == 'general':
            continue
        props = dict(parser.items(section))
        profile_path = Path(props['path'])
        if props['isrelative'] == '1':
            profile_path = ini_path.parent / profile_path
        yield props['name'], profile_path


def select_profile():
    profiles = list(local_profiles())
    print("Select the Firefox profile to infect\n")
    while True:
        for i, profile in enumerate(profiles):
            print('{}: {} ({})'.format(i+1, *profile))
        choice = raw_input("\nEnter the number besides your choice (or 'q' to cancel): ")
        if choice.lower() == 'q':
            sys.exit()
        try:
            num_choice = int(choice, base=10)
            if 0 < num_choice <= len(profiles):
                return profiles[num_choice - 1]
        except ValueError:
            pass


def install_greasemonkey(profile):
    pass


def main():
    profile = select_profile()
    print(profile)
    # import ipdb; ipdb.set_trace()

if __name__ == '__main__':
    main()
